#!/usr/bin/env bash
# frozen_string_literal: true
#
# pre-push hook: push前に変更されたファイルに関連するRSpecテスト、RuboCop、ESLint、Stylelint、
# Brakeman、Slim-Lintを実行し、いずれかが失敗した場合はpushを阻止する
#
# セットアップ: bin/setup-git-hooks を実行するか、このファイルを .git/hooks/pre-push にコピーしてください

set -e

# リポジトリのルートディレクトリに移動
# .git/hooks/pre-pushから実行される場合も考慮して、.gitディレクトリの親を取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ "$SCRIPT_DIR" == *"/.git/hooks" ]]; then
  # .git/hooks/pre-pushから実行される場合
  REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
  # bin/pre-pushから直接実行される場合
  REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi
cd "$REPO_ROOT"

# 色付き出力
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() {
  echo -e "${GREEN}[pre-push]${NC} $1"
}

warn() {
  echo -e "${YELLOW}[pre-push]${NC} $1"
}

error() {
  echo -e "${RED}[pre-push]${NC} $1"
}

# 変更されたファイルから関連するspecファイルを特定する
# 引数: 変更されたファイルのパス（改行区切り）
# 出力: 実行するspecファイルのパス（重複なし、改行区切り）
get_related_specs() {
  local changed_files="$1"
  local spec_files=""
  local run_all_specs=false

  while IFS= read -r file; do
    [[ -z "$file" ]] && continue

    case "$file" in
      # specファイル自体の変更
      spec/*_spec.rb)
        spec_files="${spec_files}${file}"$'\n'
        ;;
      # モデル: app/models/user.rb -> spec/models/user_spec.rb
      app/models/*.rb)
        local model_name
        model_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/models/${model_name}_spec.rb"$'\n'
        ;;
      # コントローラー: app/controllers/users_controller.rb -> spec/requests/users_spec.rb
      app/controllers/*_controller.rb)
        local controller_name
        controller_name=$(basename "$file" _controller.rb)
        spec_files="${spec_files}spec/requests/${controller_name}_spec.rb"$'\n'
        ;;
      # ポリシー: app/policies/user_policy.rb -> spec/policies/user_policy_spec.rb
      app/policies/*_policy.rb)
        local policy_name
        policy_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/policies/${policy_name}_spec.rb"$'\n'
        ;;
      # バリデータ: app/validators/X_validator.rb -> spec/validators/X_validator_spec.rb
      app/validators/*.rb)
        local validator_name
        validator_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/validators/${validator_name}_spec.rb"$'\n'
        ;;
      # デコレーター: app/decorators/X.rb -> spec/decorators/X_spec.rb
      app/decorators/*.rb)
        local decorator_name
        decorator_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/decorators/${decorator_name}_spec.rb"$'\n'
        ;;
      # ジョブ: app/jobs/X_job.rb -> spec/jobs/X_job_spec.rb
      app/jobs/*.rb)
        local job_name
        job_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/jobs/${job_name}_spec.rb"$'\n'
        ;;
      # メーラー: app/mailers/X_mailer.rb -> spec/mailers/X_mailer_spec.rb
      app/mailers/*.rb)
        local mailer_name
        mailer_name=$(basename "$file" .rb)
        spec_files="${spec_files}spec/mailers/${mailer_name}_spec.rb"$'\n'
        ;;
      # 設定・DB・サポート・ファクトリの変更は全specを実行
      config/*|db/*|spec/support/*|spec/factories/*|Gemfile|Gemfile.lock)
        run_all_specs=true
        ;;
      # その他のapp配下（helpers, serializers等）は全specを実行（直接のspecがないため）
      app/*)
        run_all_specs=true
        ;;
      # その他（lib等）
      *)
        run_all_specs=true
        ;;
    esac
  done <<< "$changed_files"

  if [[ "$run_all_specs" == true ]]; then
    echo "spec"
    return
  fi

  # 重複を除去し、存在するspecファイルのみを出力
  echo "$spec_files" | sort -u | while IFS= read -r spec; do
    [[ -z "$spec" ]] && continue
    if [[ -f "$spec" ]]; then
      echo "$spec"
    fi
  done
}

# 変更ファイルを取得（新規追加・変更・コピー・リネームを含む）
# stdin形式: local_ref local_sha remote_ref remote_sha
# remote_sha..local_sha の差分がpush対象
# --diff-filter=ACMR: A=Added(新規追加), C=Copied(コピー), M=Modified(変更), R=Renamed(リネーム)
get_changed_files() {
  local remote_sha="$1"
  local local_sha="$2"

  # 新規ブランチのpush（remote_shaが40個の0または空）の場合は全変更ファイルを対象
  if [[ -z "$remote_sha" || "$remote_sha" == 0000000000000000000000000000000000000000 ]]; then
    # 新規ブランチの場合、そのコミットに含まれる全ファイル（新規追加含む）を取得
    # git diff-treeを使うことで、新規ブランチでも正しく動作する
    git diff-tree --no-commit-id --name-only --diff-filter=ACMR -r "$local_sha" 2>/dev/null || \
    git show --name-only --pretty=format: --diff-filter=ACMR "$local_sha" 2>/dev/null || \
    echo ""
  else
    # 既存ブランチの場合、リモートとの差分（新規追加含む）を取得
    git diff --name-only --diff-filter=ACMR "$remote_sha".."$local_sha"
  fi
}

# メイン処理
main() {
  # 標準入力からref情報を読み取る（pre-push hookはstdinから受け取る）
  local run_tests=false
  local all_changed_files=""

  while read -r local_ref local_sha remote_ref remote_sha; do
    # remote_shaが空の場合は、新規ブランチのpushとして扱う
    if [[ -z "$remote_sha" || "$remote_sha" == "0"* ]]; then
      remote_sha="0000000000000000000000000000000000000000"
    fi
    
    [[ -z "$local_sha" || "$local_sha" == "0"* ]] && continue

    local changed_files
    changed_files=$(get_changed_files "$remote_sha" "$local_sha")
    [[ -n "$changed_files" ]] && run_tests=true
    all_changed_files="${all_changed_files}${changed_files}"$'\n'
  done

  if [[ "$run_tests" != true ]]; then
    info "変更されたファイルがありません。pushを続行します。"
    exit 0
  fi

  # Ruby/RSpecの変更を検出（.rbファイルまたはspec関連）
  local ruby_changes
  ruby_changes=$(echo "$all_changed_files" | grep -E '\.(rb)$|^spec/|^app/|^config/|^db/|Gemfile|\.rubocop\.yml' || true)

  # JavaScriptの変更を検出（.jsファイル）
  local js_changes
  js_changes=$(echo "$all_changed_files" | grep -E '\.(js)$|^app/javascript/|package\.json|\.eslintrc' || true)

  # SCSS/CSSの変更を検出
  local scss_changes
  scss_changes=$(echo "$all_changed_files" | grep -E '\.(scss|css)$|^app/assets/stylesheets/|\.stylelintrc' || true)

  # Slimテンプレートの変更を検出
  local slim_changes
  slim_changes=$(echo "$all_changed_files" | grep -E '\.slim$|^app/views/' || true)

  local has_ruby_changes=false
  local has_js_changes=false
  local has_scss_changes=false
  local has_slim_changes=false
  [[ -n "$ruby_changes" ]] && has_ruby_changes=true
  [[ -n "$js_changes" ]] && has_js_changes=true
  [[ -n "$scss_changes" ]] && has_scss_changes=true
  [[ -n "$slim_changes" ]] && has_slim_changes=true

  if [[ "$has_ruby_changes" != true && "$has_js_changes" != true && "$has_scss_changes" != true && "$has_slim_changes" != true ]]; then
    info "lint/テストに関連する変更がありません。pushを続行します。"
    exit 0
  fi

  local failed=false

  # Brakemanの実行（セキュリティスキャン）
  if [[ "$has_ruby_changes" == true ]]; then
    info "Brakemanを実行しています（セキュリティスキャン）..."
    # --no-exit-on-warn: 警告があってもexit code 0を返す（エラーのみで停止）
    # カレントディレクトリを明示的に指定（.gitディレクトリから実行される場合があるため）
    # サブシェルで実行してカレントディレクトリを確実に変更
    if (
      cd "$REPO_ROOT" || exit 1
      bundle exec brakeman --no-pager --quiet --no-exit-on-warn
    ); then
      info "Brakemanチェックが成功しました。"
    else
      error "Brakemanチェックでエラーが発生しました。pushを中止します。"
      error "修正後、再度pushしてください。"
      failed=true
    fi
  fi

  # RuboCopの実行
  if [[ "$has_ruby_changes" == true ]]; then
    local rb_files
    rb_files=$(echo "$ruby_changes" | grep -E '\.rb$' | tr '\n' ' ')
    if [[ -n "$rb_files" ]]; then
      info "RuboCopを実行しています..."
      if bundle exec rubocop $rb_files; then
        info "RuboCopチェックが成功しました。"
      else
        error "RuboCopチェックが失敗しました。pushを中止します。"
        error "修正後、再度pushしてください。"
        failed=true
      fi
    fi
  fi

  # Slim-Lintの実行
  if [[ "$has_slim_changes" == true ]]; then
    local slim_files
    slim_files=$(echo "$slim_changes" | grep -E '\.slim$' | tr '\n' ' ')
    if [[ -n "$slim_files" ]]; then
      info "Slim-Lintを実行しています..."
      if bundle exec slim-lint $slim_files; then
        info "Slim-Lintチェックが成功しました。"
      else
        error "Slim-Lintチェックが失敗しました。pushを中止します。"
        error "修正後、再度pushしてください。"
        failed=true
      fi
    fi
  fi

  # ESLintの実行
  if [[ "$has_js_changes" == true ]]; then
    info "ESLintを実行しています..."
    if command -v npm >/dev/null 2>&1 && [[ -f package.json ]]; then
      if [[ ! -d node_modules ]]; then
        warn "node_modulesが見つかりません。npm installを実行します..."
        npm install --silent
      fi
      local js_files
      js_files=$(echo "$js_changes" | grep -E '\.js$' | grep -v -E '\.eslintrc\.js|\.stylelintrc\.js' | tr '\n' ' ')
      if [[ -n "$js_files" ]]; then
        if npm run lint -- $js_files; then
          info "ESLintチェックが成功しました。"
        else
          error "ESLintチェックが失敗しました。pushを中止します。"
          error "修正後、再度pushしてください。"
          failed=true
        fi
      else
        info "ESLint対象のJavaScriptファイルがありません。"
      fi
    else
      warn "npmが見つからないか、package.jsonが存在しません。ESLintチェックをスキップします。"
    fi
  fi

  # Stylelintの実行
  if [[ "$has_scss_changes" == true ]]; then
    info "Stylelintを実行しています..."
    if command -v npm >/dev/null 2>&1 && [[ -f package.json ]]; then
      if [[ ! -d node_modules ]]; then
        warn "node_modulesが見つかりません。npm installを実行します..."
        npm install --silent
      fi
      local scss_files
      scss_files=$(echo "$scss_changes" | grep -E '\.(scss|css)$' | tr '\n' ' ')
      if [[ -n "$scss_files" ]]; then
        if npm run lint:css -- $scss_files; then
          info "Stylelintチェックが成功しました。"
        else
          error "Stylelintチェックが失敗しました。pushを中止します。"
          error "修正後、再度pushしてください。"
          failed=true
        fi
      else
        info "Stylelint対象のSCSS/CSSファイルがありません。"
      fi
    else
      warn "npmが見つからないか、package.jsonが存在しません。Stylelintチェックをスキップします。"
    fi
  fi

  # RSpecの実行
  if [[ "$has_ruby_changes" == true ]]; then
    local specs_to_run
    specs_to_run=$(get_related_specs "$ruby_changes")

    if [[ -n "$specs_to_run" ]]; then
      info "関連するRSpecテストを実行しています..."
      if [[ "$specs_to_run" == "spec" ]]; then
        info "全specを実行します（設定・DB・サポート等の変更を検出）"
        if bundle exec rspec spec; then
          info "すべてのテストが成功しました。"
        else
          error "テストが失敗しました。pushを中止します。"
          error "修正後、再度pushしてください。"
          failed=true
        fi
      else
        local spec_files
        spec_files=$(echo "$specs_to_run" | tr '\n' ' ')
        info "実行対象: $spec_files"
        if bundle exec rspec $spec_files; then
          info "すべてのテストが成功しました。"
        else
          error "テストが失敗しました。pushを中止します。"
          error "修正後、再度pushしてください。"
          failed=true
        fi
      fi
    fi
  fi

  if [[ "$failed" == true ]]; then
    exit 1
  fi

  info "すべてのチェックが成功しました。pushを続行します。"
  exit 0
}

main
