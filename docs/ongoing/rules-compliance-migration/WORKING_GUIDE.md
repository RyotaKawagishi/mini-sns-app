# 作業ガイド

このドキュメントは、ルール準拠への移行タスクを進める際の作業方針と手順を記載しています。

## 基本方針

### 進め方
1. **フェーズごとに順次実施**: `migration-plan.md` に記載されたフェーズを順番に進める
2. **フェーズごとにPR作成**: 各フェーズが完了したら、`.cursor/rules/create-pullrequest.mdc` の手順に従ってPRを作成
3. **不明点は適宜質問**: 作業中に不明点があれば、都度確認する

### 作業の流れ

```
フェーズ開始
  ↓
作業実施
  ↓
テスト実行・動作確認
  ↓
チェックリスト更新
  ↓
PR作成
  ↓
次のフェーズへ
```

## PR作成のタイミングと手順

### タイミング
- **各フェーズの作業が完了した時点**でPRを作成
- フェーズ内の一部の作業だけではPRを作成しない（フェーズ単位で完結させる）

### PR作成手順

1. **必須前提条件の確認**
   - 関連Issueの確認
     - Issueのリンクが提供されていない場合は、必ず「関連するIssueのリンクはありますか？」と確認
     - Issueが存在しない場合は、「Issueなし」とPRの説明に明記

2. **差分の確認**
   - マージ先ブランチ（デフォルト: `main`）との差分を確認
   ```bash
   git diff origin/main...HEAD | cat
   ```

3. **PRテンプレートの準備**
   - `.github/pull_request_template.md` からテンプレート内容を取得
   - PRタイトルは差分をもとに適切に設定
   - 各セクションを明確に区分して記入

4. **PR作成**
   - 指示がない限り **Draft** でPRを作成
   - `.cursor/rules/create-pullrequest.mdc` の手順に従う
   - 詳細は `docs/PR_CREATION_GUIDE.md` を参照

### PRに含めるべき情報

- **概要**: フェーズで実施した作業の概要
- **関連Issue**: Issue番号または「Issueなし」の明記
- **変更内容**: 実施した変更の箇条書き
- **実装詳細**: 重要な実装の詳細や設計の意図
- **テスト**: 実施したテストの内容
- **チェックリスト**: 完了した項目の確認

## 各フェーズの進め方

### フェーズ1: 準備と基盤整備

**作業内容**:
- プロジェクト分析
- ルールの調整検討

**完了条件**:
- [ ] 現状のコードベースの詳細分析完了
- [ ] 依存関係の整理完了
- [ ] 影響範囲の特定完了
- [ ] ルール調整案の作成（必要に応じて）

**PR作成**: フェーズ1の全作業完了後

---

### フェーズ2: ドキュメンテーションと軽微な修正

**作業内容**:
- Yard記法の追加
- マイグレーションコメントの追加

**完了条件**:
- [ ] モデルメソッドへのYard記法追加完了
- [ ] コントローラーメソッドへのYard記法追加完了
- [ ] 全マイグレーションファイルへのコメント追加完了

**PR作成**: フェーズ2の全作業完了後

---

### フェーズ3: カスタムバリデーションの分離

**作業内容**:
- Validatorの作成
- モデルの更新

**完了条件**:
- [ ] `app/validators/` ディレクトリの作成
- [ ] カスタムバリデーションのValidatorへの移行完了
- [ ] テストの更新と動作確認完了

**PR作成**: フェーズ3の全作業完了後

---

### フェーズ4: 認可ロジックの分離

**作業内容**:
- Punditの導入
- Policyの作成
- コントローラーの更新

**完了条件**:
- [ ] Pundit gemの追加と設定完了
- [ ] Policyの作成完了
- [ ] コントローラーの更新完了
- [ ] テストの更新と動作確認完了

**PR作成**: フェーズ4の全作業完了後

---

### フェーズ5以降（オプション）

フェーズ5（ルーティングの見直し）以降は、必要に応じて実施します。
各フェーズの完了後にPRを作成する方針は同じです。

## 不明点の確認方法

作業中に以下のような不明点が発生した場合:

1. **ルールの解釈が不明確**
   - `.cursor/rules/` 配下の該当ルールファイルを確認
   - 必要に応じて質問

2. **実装方法が不明**
   - 既存コードを参考にする
   - 必要に応じて質問

3. **テスト方法が不明**
   - 既存のテストを参考にする
   - 必要に応じて質問

4. **PRの内容が適切か不明**
   - `.cursor/rules/create-pullrequest.mdc` を確認
   - `docs/PR_CREATION_GUIDE.md` を参照

## チェックリストの更新

各フェーズの作業を進める際は、`checklist.md` を随時更新してください。

- 作業開始時: 該当フェーズのセクションを確認
- 作業中: 完了した項目にチェックを入れる
- 作業完了時: すべての項目が完了していることを確認

## 参考ドキュメント

- `migration-plan.md` - 詳細な移行計画
- `checklist.md` - 作業チェックリスト
- `validation-report.md` - 検証結果の詳細
- `docs/PR_CREATION_GUIDE.md` - PR作成ガイド
- `.cursor/rules/create-pullrequest.mdc` - PR作成ルール

