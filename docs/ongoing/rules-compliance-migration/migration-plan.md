# ルール準拠への移行計画

> **注意**: このドキュメントは移行計画のテンプレートです。実際の移行作業を開始する前に、詳細を詰めてください。

## 移行方針

### 基本方針
1. **段階的移行**: 一度にすべてを変更せず、フェーズを分けて実施
2. **機能維持**: 既存機能を壊さないことを最優先
3. **テスト駆動**: 各フェーズでテストを実行し、動作確認を徹底

### 移行戦略の選択

#### オプションA: ルールを現状に合わせて調整
- **メリット**: 既存コードへの影響が少ない
- **デメリット**: ルールの意図が失われる可能性
- **適用例**: ルーティング規約の調整（Webアプリ向けに）

#### オプションB: コードをルールに合わせて変更
- **メリット**: ルールの意図を完全に反映
- **デメリット**: 大規模なリファクタリングが必要
- **適用例**: 認可ロジックのPolicyへの分離

#### オプションC: ハイブリッド
- **メリット**: バランスの取れたアプローチ
- **デメリット**: 判断が複雑になる
- **推奨**: この方針を採用

---

## フェーズ別移行計画

### フェーズ1: 準備と基盤整備

#### 1.1 プロジェクト分析
- [x] 現状のコードベースの詳細分析
  - 結果: `phase1-analysis.md` に記録
- [x] 依存関係の整理
  - 結果: `phase1-analysis.md` に記録
- [x] 影響範囲の特定
  - 結果: `phase1-analysis.md` に記録

#### 1.2 ルールの調整検討
- [x] Webアプリケーション向けのルール調整案の作成
  - 結果: `phase1-rule-adjustment-proposal.md` に記録
- [ ] ルールファイルの更新（必要に応じて）
  - 調整案の承認後に実施予定

**期間見積もり**: 1-2週間
**進捗**: 分析と調整案作成は完了。ルールファイルの更新は承認待ち。

---

### フェーズ2: ドキュメンテーションと軽微な修正

#### 2.1 Yard記法の追加
- [ ] モデルメソッドへのYard記法追加
- [ ] コントローラーメソッドへのYard記法追加
- [ ] ドキュメント生成と確認

#### 2.2 マイグレーションコメントの追加
- [ ] 既存マイグレーションファイルへのコメント追加
- [ ] コメントの一貫性確認

**期間見積もり**: 1-2週間

---

### フェーズ3: カスタムバリデーションの分離

#### 3.1 Validatorの作成
- [ ] `app/validators/` ディレクトリの作成
- [ ] `ReplyToUserValidator` の作成
- [ ] `CannotReplyToSelfValidator` の作成

#### 3.2 モデルの更新
- [ ] `Micropost` モデルのバリデーションを更新
- [ ] テストの更新と動作確認

**期間見積もり**: 1週間

---

### フェーズ4: 認可ロジックの分離

#### 4.1 Punditの導入
- [ ] Pundit gemの追加
- [ ] `ApplicationPolicy` の作成
- [ ] 基本設定

#### 4.2 Policyの作成
- [ ] `UserPolicy` の作成
- [ ] `MicropostPolicy` の作成
- [ ] 既存の認可ロジックを移行

#### 4.3 コントローラーの更新
- [ ] `before_action` を `authorize` に置き換え
- [ ] テストの更新と動作確認

**期間見積もり**: 2-3週間

---

### フェーズ5: ルーティングの見直し（オプション）

#### 5.1 ルーティング設計の検討
- [ ] 現状のルーティングの評価
- [ ] DHHルーティングへの移行可能性の検討
- [ ] 代替案の検討

#### 5.2 ルーティングの更新（決定した場合）
- [ ] ルートの再設計
- [ ] コントローラーの更新
- [ ] ビューの更新（必要に応じて）

**期間見積もり**: 2-3週間（オプション）

---

### フェーズ6: テストフレームワークの移行（オプション）

#### 6.1 RSpecの導入準備
- [ ] RSpec gemの追加
- [ ] 設定ファイルの作成
- [ ] FactoryBotの設定

#### 6.2 テストの移行
- [ ] 既存テストのRSpecへの変換
- [ ] FactoryBotへの移行
- [ ] テストカバレッジの確認

**期間見積もり**: 3-4週間（オプション）

---

### フェーズ7: API設計ツールの導入（将来）

#### 7.1 APIエンドポイントの設計
- [ ] API要件の定義
- [ ] OpenAPI仕様の作成

#### 7.2 ツールの導入
- [ ] Blueprinterの導入
- [ ] Committee Railsの導入
- [ ] Serializerの実装

**期間見積もり**: 未定（将来の作業）

---

## 依存関係

```
フェーズ1 (準備)
  ↓
フェーズ2 (ドキュメンテーション)
  ↓
フェーズ3 (バリデーション)
  ↓
フェーズ4 (認可)
  ↓
フェーズ5 (ルーティング) [オプション]
  ↓
フェーズ6 (テスト) [オプション]
  ↓
フェーズ7 (API) [将来]
```

## リスク管理

### 高リスク項目
1. **テストフレームワークの移行**: 既存テストの動作保証が困難
2. **ルーティングの変更**: 既存のURLが変更される可能性

### リスク軽減策
1. 各フェーズで十分なテストを実施
2. 段階的な移行で影響範囲を限定
3. ロールバック計画の準備

## 成功基準

各フェーズの完了条件:
- [ ] 既存のテストがすべて通過
- [ ] 新規追加したテストが通過
- [ ] コードレビュー完了
- [ ] ドキュメント更新完了

## Pull Request作成

各フェーズ完了時は、`.cursor/rules/create-pullrequest.mdc` の手順に従ってPRを作成してください。

### PR作成時のチェックリスト
- [ ] 関連Issueの確認（Issueがない場合は明記）
- [ ] マージ先ブランチとの差分確認
- [ ] PRテンプレート（`.github/pull_request_template.md`）に従って記入
- [ ] DraftでPRを作成（指示がない限り）
- [ ] ブラウザでPRを確認

詳細は `docs/PR_CREATION_GUIDE.md` を参照してください。

